#!/bin/sh -e
#
# SatNOGS station installation script
#
# Copyright (C) 2024 Libre Space Foundation <https://libre.space/>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

DOCKER_BINDMOUNTS_DIR="/var/lib/docker-bindmounts"
DOCKER_ANSIBLE_IMAGE="librespace/ansible:8.4.0"
DOCKER_ANSIBLE_NAME="ansible"
DOCKER_ANSIBLE_CONFIG_DIR="/etc/ansible"
DOCKER_ANSIBLE_PLAYBOOK_URL="https://gitlab.com/librespacefoundation/satnogs/satnogs-ansible.git"
DOCKER_ANSIBLE_CHECKOUT_REF="stable"

usage() {
	cat 1>&2 <<EOF
Usage: $(basename "$0") [OPTIONS]... COMMAND
SatNOGS station installation script

Options:
  -C <ref>                  Branch/tag/commit of SatNOGS Ansible to checkout.
                             (default: 'stable')
  -U <url>                  URL of SatNOGS Ansible repository.
  --help                    Print usage

EOF
	exit 1
}

parse_args() {
	while [ $# -gt 0 ]; do
		arg="$1"
		case $arg in
			-C)
				shift
				if [ -z "$1" ]; then
					usage
				fi
				checkout_ref="$1"
				;;
			-U)
				shift
				if [ -z "$1" ]; then
					usage
				fi
				playbook_url="$1"
				;;
			--help)
				usage
				;;
			*)
				;;
		esac
		shift
	done
}

install_docker() {
	echo "Installing Docker..."
	apt-get -qq update
	apt-get -qqy install docker.io
	echo
}

configure_ansible() {
	echo "Configuring SatNOGS Ansible..."
	mkdir -p "${DOCKER_BINDMOUNTS_DIR}/${DOCKER_ANSIBLE_NAME}${DOCKER_ANSIBLE_CONFIG_DIR}"

	cat <<EOF >"${DOCKER_BINDMOUNTS_DIR}/${DOCKER_ANSIBLE_NAME}${DOCKER_ANSIBLE_CONFIG_DIR}/hosts"
all:
  hosts:
    ${DOCKER_ANSIBLE_NAME}:
      ansible_connection: 'community.docker.nsenter'
satnogses:
  hosts:
    ${DOCKER_ANSIBLE_NAME}:
EOF

	cat <<EOF >"${DOCKER_BINDMOUNTS_DIR}/${DOCKER_ANSIBLE_NAME}${DOCKER_ANSIBLE_CONFIG_DIR}/ansible.cfg"
[defaults]
interpreter_python = auto_silent
EOF
	echo
}

main() {
	playbook_url="$DOCKER_ANSIBLE_PLAYBOOK_URL"
	checkout_ref="$DOCKER_ANSIBLE_CHECKOUT_REF"

	parse_args "$@"

	install_docker
	configure_ansible

	echo "Executing SatNOGS Ansible..."
	exec docker run \
	     -ti \
	     --rm \
	     --name "${DOCKER_ANSIBLE_NAME}" \
	     --hostname "${DOCKER_ANSIBLE_NAME}" \
	     --privileged \
	     --pid=host \
	     -v "${DOCKER_BINDMOUNTS_DIR}/${DOCKER_ANSIBLE_NAME}${DOCKER_ANSIBLE_CONFIG_DIR}:${DOCKER_ANSIBLE_CONFIG_DIR}:ro" \
	     -v "/root/.ansible/pull:/root/.ansible/pull:ro" \
	     "${DOCKER_ANSIBLE_IMAGE}" \
	     ansible-pull \
	     -i "${DOCKER_ANSIBLE_CONFIG_DIR}" \
	     -U "${playbook_url}" \
	     -C "${checkout_ref}"
}

main "$@"
